%define mod_path /opt/monitor/op5/merlin

%define latest_db_version 1
# prevent stripping of binaries
%define __spec_install_post /usr/lib/rpm/brp-compress

%{?dgroup:%define daemon_group %{dgroup}}

Summary: %name is a Nagios module designed to communicate with Merlin
Name: monitor-merlin
Version: @@VERSION@@
Release: @@RELEASE@@
License: GPL
Group: op5/Monitor
URL: http://www.op5.se
Source0: %name-%version.tar.gz
Prefix: /opt/monitor
Requires: monitor >= 4.0, %name-daemon
BuildRequires: mysql-devel
BuildRoot: /override/%name-%version
PreReq: monitor-webconfig >= 3.3.0

%description
%name is an event broker module running inside Nagios. Its' only
purpose in life is to send events from the Nagios core to the merlin
daemon, which then takes appropriate action.


%package merlin
Summary: The merlin daemon is a multiplexing event-transport program
Group: op5/Monitor
Requires: libdbi

%description merlin
The merlin daemon is a multiplexing event-transport program designed to
link multiple Nagios instances together. It can also inject status
data into a variety of databases, using libdbi.


%prep
%setup -q

%build
CFLAGS="%optflags" make

%install
rm -rf %buildroot
make DESTDIR=%buildroot%mod_path install
chmod 755 %buildroot%mod_path/{merlind,merlin.so}
chmod 644 %buildroot%mod_path/db.sql


%pre
# If we're upgrading the module while Nagios makes a call
# into it, we'll end up with a core-dump due to some weirdness
# in dlopen(). If we're installing anew, we need to update the
# config and then restart. Either way, it's safe to stop it
# unconditionally here
sh /etc/rc.d/init.d/monitor stop || :
sh /etc/rc.d/init.d/monitor slay || :


%preun
if [ $1 -eq 0 ]; then
	# removing the ndbneb module entirely
	sh /etc/rc.d/init.d/monitor stop || :
	sh /etc/rc.d/init.d/monitor slay || :
	sed -i /merlin.so/d %prefix/etc/nagios.cfg
	sh /etc/rc.d/init.d/monitor start || :
fi

%post
# first fix database permissions. We do this unconditionally
mysql -e \
  'GRANT ALL ON monitor_gui.* TO monitor@localhost IDENTIFIED BY "monitor"'
mysql -e 'FLUSH PRIVILEGES'

# next we check if we need to create the database
query="SELECT last_check FROM report_data LIMIT 1"
mysql monitor_reports -Be "$query" >/dev/null 2>&1 || {
	echo "Creating database"
	mysqladmin create monitor_gui >/dev/null 2>&1 || :
	mysql monitor_gui < %mod_path/db.sql
}

# Add the module to the nagios configuration
grep -q merlin.so %prefix/etc/nagios.cfg || \
	sed -i 's#^log_file.*#broker_module=%mod_path/merlin.so %mod_path/merlin.conf\n\n&#' \
		%prefix/etc/nagios.cfg

# now start monitor again
/etc/rc.d/init.d/monitor start


%files
%defattr(-,root,root)
%mod_path/merlin.so

%files merlin
%defattr(-,root,root)
%mod_path/merlin.conf
%mod_path/db.sql
%mod_path/merlind

%changelog
* Tue Mar 17 2009 Andreas Ericsson <ae@op5.se>
- Initial specfile creation.
